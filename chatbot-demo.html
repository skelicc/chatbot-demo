<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CityLuxe Chatbot</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>
  <script>
    (function() {
      // Ovdje staviš sav JS koji si poslao (isto kao što si ga poslao gore)

      // 1. Dinamički ubaci CSS
      const css = `
  :root {
    --gold: #B38728;
    --gold-dark: #9a7221;
    --navy: #1a1a2e;
    --navy-light: #2c3e50;
  }
  
  body {
    font-family: 'DM Sans', sans-serif;
    margin: 0;
    padding: 0;
    color: #333;
  }

  #chat-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px; 
    width: 60px;
    height: 60px;
    background-color: var(--gold);
    border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 28px;
    transition: all 0.3s ease;
    border: 2px solid white;
  }

  #chat-toggle:hover {
    background-color: var(--gold-dark);
    transform: scale(1.05);
  }

  #chatbox {
    position: fixed;
    bottom: 90px;
    right: 10px;
    width: 461px;
    height: 635px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
    z-index: 9999;
    font-family: 'Segoe UI', Helvetica, Arial, sans-serif;
    animation: slideIn 0.3s ease;
    border: 1px solid #e0e0e0;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  #chat-header {
    background: linear-gradient(135deg, var(--navy), var(--navy-light));
    color: white;
    padding: 12px 15px;
    display: flex;
    align-items: center;
    border-top: 1px solid white;
    border-right: 1px solid white;
    border-left: 1px solid white;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
  }

  .header-icon {
    width: 36px;
    height: 36px;
    background-color: var(--gold);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 18px;
    border: 2px solid white;
  }

  .header-text { flex: 1; }
  
  .header-title { 
    font-weight: 600; 
    font-size: 15px; 
    margin-bottom: 2px; 
  }
  
  .header-subtitle {
    font-size: 11px;
    color: white;
    display: flex;
    align-items: center;
  }

  .online {
    width: 7px;
    height: 7px;
    background-color: green;
    border-radius: 50%;
    margin: 0 6px;
  }

  .premium {
    width: 5px;
    height: 5px;
    background-color: gray;
    border-radius: 50%;
    margin: 0 6px;
  }

  .header-close {
    cursor: pointer;
    font-size: 18px;
    margin-left: 10px;
    opacity: 0.7;
  }

  .header-close:hover { opacity: 1; }

  #chat-close-btn {
    width: 28px;
    height: 28px;
    background-color: #e0e0e0;
    color: #333;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  }

  #chat-close-btn:hover {
    background-color: #d0d0d0;
  }

  .close {
    text-align: center;
    margin-top: -1px;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  }

  .msg {
    margin: 8px 0;
    padding: 12px 15px;
    border-radius: 18px;
    max-width: 85%;
    line-height: 1.5;
    font-size: 14px;
    word-wrap: break-word;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .user {
    background: var(--navy);
    align-self: flex-end;
    color: white;
    border-bottom-right-radius: 5px;
  }

  .bot {
    background: #ffffff;
    align-self: flex-start;
    color: #333;
    border-bottom-left-radius: 5px;
  }

  #chat-input-container {
    padding: 12px;
    background: white;
    border-top: 1px solid #e0e0e0;
  }

  #chat-input {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  #userInput {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    font-size: 14px;
    outline: none;
  }

  #userInput:focus { border-color: var(--gold); }

  #sendButton {
    padding: 10px 16px;
    background: var(--gold);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
  }

  #sendButton:hover { background: var(--gold-dark); }

  .suggestions {
    display: flex;
    gap: 6px;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .suggestion {
    background: #f0f0f0;
    border-radius: 15px;
    padding: 6px 12px;
    font-size: 12px;
    color: #555;
    cursor: pointer;
    flex: 1;
    text-align: center;
    min-width: 0;
  }

  .watermark {
    font-size: 12px;
    color: #000000;
    opacity: 0.6;
    text-align: center;
    padding-right: 4px;
    margin-top: 4px;
  }

  .suggestion:hover {
    background: #e0e0e0;
    transform: translateY(-1px);
  }

  .msg button {
    background: var(--gold);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 4px 0;
    cursor: pointer;
    width: 100%;
  }

  .msg button:hover {
    background: var(--gold-dark);
  }

  .msg select, .msg input[type="text"] {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    width: 100%;
    font-size: 14px;
    background: white;
    margin-bottom: 10px;
  }

  .msg label {
    font-size: 13px;
    color: #555;
    margin-bottom: 6px;
    display: block;
    font-weight: 500;
  }

  .premium-form-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--navy);
    margin-bottom: 15px;
    text-align: center;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
  }

  #chat-tooltip {
    position: absolute;
    bottom: 70px;
    right: 0;
    background: white;
    color: var(--navy);
    padding: 10px 14px;
    font-size: 13px;
    border-radius: 12px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: opacity 0.4s ease, transform 0.4s ease;
    font-family: 'Segoe UI', sans-serif;
  }

  #chat-tooltip.show {
    opacity: 1;
    transform: translateY(0);
  }

  .typing-dot {
    width: 10px;
    height: 10px;
    background-color: var(--gold);
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
    animation: blink 1.2s infinite;
  }

  .typing-dot:nth-child(2) {
    animation-delay: 0.2s;
  }

  .typing-dot:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes blink {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
  }

  .header-icon i {
    color: white !important;
  }

  @keyframes glow {
    0%, 100% {
      box-shadow: 0 0 10px 4px rgba(255, 215, 0, 0.7);
    }
    50% {
      box-shadow: 0 0 20px 6px rgba(255, 215, 0, 1);
    }
  }

  #chat-toggle.glow {
    animation: glow 1.2s ease-in-out infinite;
  }

  #chat-input-container {
    padding: 12px;
    background: white;
    border-top: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
  }

  .questions-toggle {
    background: #f5f5f5;
    padding: 10px 15px;
    border-radius: 8px;
    margin: 8px 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 500;
    color: var(--navy);
    border: 1px solid #e0e0e0;
  }

  .questions-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    background: #f9f9f9;
    border-radius: 8px;
    margin-bottom: 8px;
  }

  .questions-container.open {
    max-height: 500px;
  }

  .question-item {
    padding: 8px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    font-size: 14px;
  }

  .question-item:hover {
    background: #f0f0f0;
  }

  .quick-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin: 10px 0;
    padding: 0 10px;
  }

  .quick-action {
    background: var(--gold);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    text-align: center;
    font-size: 13px;
    cursor: pointer;
  }

  .quick-action:hover {
    background: var(--gold-dark);
  }

  /* Mobile-specific styles */
  @media (max-width: 768px) {
    #chatbox {
      width: 100% !important;
      height: 100% !important;
      max-width: none !important;
      max-height: none !important;
      bottom: 0 !important;
      right: 0 !important;
      border-radius: 0 !important;
    }
    
    #messages {
      max-height: calc(100vh - 200px) !important;
    }
    
    body {
      overflow: hidden !important;
      position: fixed !important;
      width: 100% !important;
    }
    
    #chat-toggle {
      bottom: 15px;
      right: 15px;
    }
    
    #chat-header {
      border-radius: 0;
    }
    
    .msg {
      max-width: 90%;
    }
  }

  @media (max-width: 480px) {
    #chat-input {
      flex-direction: column;
    }
    
    #sendButton {
      width: 100%;
    }
    
    .quick-actions {
      grid-template-columns: 1fr;
    }
  }
`;

      const styleTag = document.createElement('style');
      styleTag.textContent = css;
      document.head.appendChild(styleTag);

      // 2. Dinamički ubaci HTML widgeta u body
      const html = `
      <head>
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
      </head>
        <div id="chat-toggle" title="Open chat">
          <i class="fa-regular fa-building"></i>
            <div id="chat-tooltip">Hi there! Have a question? I’m here to help.</div>

        </div>

        <div id="chatbox">
          <div id="chat-header">
            <div class="header-icon"><i class="fa-regular fa-building"></i></div>
            <div class="header-text">
              <div class="header-title">CityLuxe Assistant</div>
              <div class="header-subtitle">
               <span class="online"></span> Online <span class="premium"></span> Premium Support
              </div>
            </div>
            <div class="header-close" id="chat-close-btn"><span class="close">×</span></div>
          </div>
          <div id="messages"></div>
          <div id="chat-input-container">
  <div id="chat-input">
    <input type="text" id="userInput" placeholder="Ask about properties, areas, or services" autocomplete="off" />
    <button id="sendButton">Send</button>
  </div>
  <div class="questions-toggle">
    <span>Show Questions and Actions</span>
    <i class="fas fa-chevron-down"></i>
  </div>
  <div class="questions-container">
    <div class="quick-actions">
      <div class="quick-action" data-text="Start Property Search">Start Search</div>
      <div class="quick-action" data-text="Book Visit">Book Visit</div>
    </div>
    <div class="question-item" data-text="How long does integration take?">How long does integration take?</div>
    <div class="question-item" data-text="What is the main benefit of the agents?">What is the main benefit of the agents?</div>
  </div>
  <div class="watermark">
    Powered by Sorto
  </div>
</div>
        </div>
      `;

      const container = document.createElement('div');
      container.innerHTML = html;
      document.body.appendChild(container);

     // 3. JS funkcionalnost
const chatToggleBtn = document.getElementById("chat-toggle");
chatToggleBtn.classList.add("glow");

// Ukloni efekt nakon 5 sekundi
setTimeout(() => {
  chatToggleBtn.classList.remove("glow");
}, 5000);

// Add this code after your existing event listeners
const questionsToggle = document.querySelector(".questions-toggle");
const questionsContainer = document.querySelector(".questions-container");

questionsToggle.addEventListener("click", () => {
  questionsContainer.classList.toggle("open");
  questionsToggle.classList.toggle("open");
  
  if (questionsToggle.classList.contains("open")) {
    questionsToggle.querySelector("span").textContent = "Hide Questions and Actions";
  } else {
    questionsToggle.querySelector("span").textContent = "Show Questions and Actions";
  }
});

// Add click handlers for questions and actions
document.querySelectorAll(".question-item, .quick-action").forEach(item => {
  item.addEventListener("click", (e) => {
    e.stopPropagation();
    const text = item.getAttribute("data-text");
    
    if (text === "Start Property Search") {
      addMessage(text, "user");
      setTimeout(() => {
        addMessage("Let's find your perfect property! First, choose location:", "bot");
        setTimeout(showLocationStep, 500);
      }, 300);
    } 
    else if (text === "Book Visit") {
      addMessage(text, "user");
      setTimeout(showScheduleIntro, 300);
    }
    else {
      // For questions, just send them as messages
      inputField.value = text;
      sendMessage();
    }
  });
});



const chatToggle = document.getElementById("chat-toggle");
const chatbox = document.getElementById("chatbox");
const messages = document.getElementById("messages");
const inputField = document.getElementById("userInput");
const sendButton = document.getElementById("sendButton");
const chatCloseBtn = document.getElementById("chat-close-btn");
const suggestions = document.querySelectorAll(".suggestion");

let chatOpened = false;
let initialMessageShown = false;

let tooltipTimer;
 let currentSearch = {
        location: null,
        budget: null,
        type: null
      };
setTimeout(() => {
  const tooltip = document.getElementById("chat-tooltip");
  if (tooltip) {
    tooltip.classList.add("show");

    tooltipTimer = setTimeout(() => {
      tooltip.classList.remove("show");
    }, 8000); // stay visible 8 seconds
  }
}, 500); // show after 2 seconds



function openChat() {
  chatbox.style.display = "flex";
  if (!initialMessageShown) {
    showInitialMessage();
    initialMessageShown = true;
  }
  chatOpened = true;
}

function closeChat() {
  chatbox.style.display = "none";
  chatOpened = false;
}

// Prevent body scrolling when chat is open
function toggleBodyScroll(enable) {
  if (enable) {
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.width = '100%';
  } else {
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
  }
}

// Update your open/close functions
function openChat() {
  chatbox.style.display = "flex";
  if (!initialMessageShown) {
    showInitialMessage();
    initialMessageShown = true;
  }
  chatOpened = true;
  toggleBodyScroll(true);
}

function closeChat() {
  chatbox.style.display = "none";
  chatOpened = false;
  toggleBodyScroll(false);
}


// Replace your existing showInitialMessage() function with this:
function showInitialMessage() {
  const container = document.createElement("div");
  container.className = "msg bot";
  container.innerHTML = `
    <p>Hi there! I'm your personal CityLuxe real estate assistant. How can I help you?</p>
    
    <div style="margin-top:15px; display:flex; flex-direction:column; gap:8px;">
      <button class="quick-btn" data-text="Browse available properties">Find Properties</button>
      <button class="quick-btn" data-text="Schedule a call">Book a Private Visit</button>
      <button class="quick-btn" data-text="Explore neighborhoods">Get Investment Advice</button>
    </div>
  `;
  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;
  

}


function addMessage(message, sender) {
  const container = document.createElement("div");
  container.className = "msg " + sender;

  if (sender === "bot") {
    container.innerHTML = `
      <div style="display:flex; align-items: flex-start; gap: 10px;">
        <div class="header-icon" style="flex-shrink:0;color:white;"><i class="fa-regular fa-building"></i></div>
        <div style="padding:12px 15px; border-radius:18px;color:#333; font-size:14px; max-width:85%;">
          ${message}
        </div>
      </div>
    `;
  } else {
    container.innerText = message;
  }

  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
  const typingContainer = document.createElement("div");
  typingContainer.className = "msg bot typing";
  typingContainer.innerHTML = `
    <div style="display:flex; align-items: flex-start; gap: 10px;">
      <div class="header-icon" style="flex-shrink:0;"><i class="fa-regular fa-building"></i></div>
      <div style="background:#fff; padding:12px 15px; border-radius:18px; border:1px solid #e0e0e0; color:#B38728; font-size:20px; max-width:85%; line-height:1;">
       <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>

      </div>
    </div>
  `;
  messages.appendChild(typingContainer);
  messages.scrollTop = messages.scrollHeight;
}

async function sendMessage() {
  const text = inputField.value.trim();
  if (!text) return;
  addMessage(text, "user");
  inputField.value = "";
  showTyping();

  // Check if message contains call-related keywords
  const callKeywords = ['call', 'phone', 'schedule', 'consultation', 'meeting', 'appointment'];
  const containsCallKeyword = callKeywords.some(keyword => 
    text.toLowerCase().includes(keyword.toLowerCase())
  );

  if (containsCallKeyword) {
    // Remove typing indicator
    const typingEl = document.querySelector(".msg.typing");
    if (typingEl) typingEl.remove();
    
    // Always show the call form
    showScheduleIntro();
    return;
  }

  try {
    const res = await fetch("https://n8n-gjkiqtod.eu-central-1.clawcloudrun.com/webhook/b8ba86be-1de7-4358-9819-f3e55aaf2098", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    });

    const textData = await res.text();
    const typingEl = document.querySelector(".msg.typing");
    if (typingEl) typingEl.remove();

    let data;
    try {
      data = JSON.parse(textData);
    } catch {
      data = textData;
    }

    if (data.length === 0) {
      addMessage("Sorry, we don't have any properties matching your criteria right now. Please try another search.", "bot");
      return;
    }

    if (Array.isArray(data)) {
      renderProperties(data);
    } else if (data && typeof data === "object") {
      if (data.Location && data.Type) {
        renderProperties([data]);
      } else if (data.action === "chat" && data.reply) {
        addMessage(data.reply, "bot");
      } else {
        addMessage("Sorry, I didn't understand the response.", "bot");
      }
    } else if (typeof data === "string") {
      addMessage(data, "bot");
    } else {
      addMessage("Sorry, I didn't understand the response.", "bot");
    }
  } catch (err) {
    console.error(err);
    addMessage("Error contacting the server.", "bot");
  }
}

function renderProperties(properties) {
  if (!Array.isArray(properties) || properties.length === 0) {
    addMessage("Sorry, we don't have any properties matching your criteria right now. Please try another search.", "bot");
    return;
  }

  properties.forEach(property => {
    const imgSrc = property["Image URL"] || property["Slika URL"];
    const title = property.Title || property.Tip || "Property";
    const location = property.Location || property.Lokacija || "Unknown";
    const description = property.Description || property.Opis || "";
    const price = Number(property["Price (€)"] || property["Cijena (€)"] || 0).toLocaleString();
    const url = property["Listing URL"] || "#";


    const container = document.createElement("div");
    container.className = "msg bot";

    container.innerHTML = `
      <div style="border: 1px solid #ddd; border-radius: 12px; overflow: hidden; background: #fff; max-width: 360px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); font-family: sans-serif;">
        
        <div style="position: relative; height: 200px; background-color: #f0f0f0;">
          <img src="${imgSrc}" alt="Property Image" style="width: 100%; height: 100%; object-fit: cover;">
          <div style="position: absolute; top: 10px; right: 10px; background: #d79c00; color: white; padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 14px;">
            €${price}
          </div>
        </div>

        <div style="padding: 16px;">
          <div style="font-weight: 600; font-size: 16px; margin-bottom: 6px;">${title}</div>
          
          <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
            <i class="fa-solid fa-location-dot" style="margin-right: 6px;"></i>${location}
          </div>

          <div style="color: #333; font-size: 14px; margin-bottom: 10px;">
            <i class="fa-regular fa-building"  style="margin-right: 6px;"></i> ${description} 
          </div>

          <a href="${url}" target="_blank" style="display: inline-block; background: #0b1f66; color: white; padding: 10px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; text-decoration: none; text-align: center; width: 100%;">
            View Property Details <i class="fa-solid fa-arrow-right" style="margin-left: 6px;"></i>
          </a>
        </div>
      </div>
    `;

    messages.appendChild(container);
    messages.scrollTop = messages.scrollHeight;
  });
}

function showLocationStep() {
        const container = document.createElement("div");
        container.className = "msg bot";
        container.innerHTML = `
          <p>Perfect! Let's find your ideal property. First, choose location:</p>
          <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="step-btn" data-step="location" data-value="Amsterdam">Amsterdam</button>
            <button class="step-btn" data-step="location" data-value="London">London</button>
            <button class="step-btn" data-step="location" data-value="Dubai">Dubai</button>
            <button class="step-btn" data-step="location" data-value="Paris">Paris</button>
          </div>
        `;
        messages.appendChild(container);
        messages.scrollTop = messages.scrollHeight;
      }

      function showBudgetStep() {
        const container = document.createElement("div");
        container.className = "msg bot";
        container.innerHTML = `
          <p>Great choice! Now select your budget range:</p>
          <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="step-btn" data-step="budget" data-value="€50k - €100k">€50k - €100k</button>
            <button class="step-btn" data-step="budget" data-value="€100k - €200k">€100k - €200k</button>
            <button class="step-btn" data-step="budget" data-value="€200k - €300k">€200k - €300k</button>
            <button class="step-btn" data-step="budget" data-value="€300k+">€300k+</button>
          </div>
        `;
        messages.appendChild(container);
        messages.scrollTop = messages.scrollHeight;
      }

      function showTypeStep() {
        const container = document.createElement("div");
        container.className = "msg bot";
        container.innerHTML = `
          <p>Almost done! Finally, select property type:</p>
          <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="step-btn" data-step="type" data-value="Apartment">Apartment</button>
            <button class="step-btn" data-step="type" data-value="House">House</button>
            <button class="step-btn" data-step="type" data-value="Villa">Villa</button>
            <button class="step-btn" data-step="type" data-value="Penthouse">Penthouse</button>
          </div>
        `;
        messages.appendChild(container);
        messages.scrollTop = messages.scrollHeight;
      }

      function completeSearch() {
        const query = `Search for ${currentSearch.type} in ${currentSearch.location} priced ${currentSearch.budget}`;
    
        inputField.value = query;
        sendMessage();
        currentSearch = { location: null, budget: null, type: null }; // Reset search
      }

      // Glavni event listener za korake pretrage
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("step-btn")) {
          const step = e.target.getAttribute("data-step");
          const value = e.target.getAttribute("data-value");
          
          currentSearch[step] = value;
          addMessage(value, "user");
          
          if (step === "location") {
            setTimeout(showBudgetStep, 500);
          } 
          else if (step === "budget") {
            setTimeout(showTypeStep, 500);
          }
          else if (step === "type") {
            setTimeout(completeSearch, 500);
          }
        }
      });

      // Event listener za prijedloge
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("suggestion")) {
          const text = e.target.getAttribute("data-text");
          addMessage(text, "user");
          
          if (text === "Start Property Search") {
            setTimeout(() => {
              addMessage("Let's find your perfect property! First, choose location:", "bot");
              setTimeout(showLocationStep, 500);
            }, 300);
          }
          else if (text === "Book Visit") {
            setTimeout(() => {

              setTimeout(showScheduleIntro, 500);
            }, 300);
          }
          else if (text === "Areas") {
            setTimeout(() => {
              addMessage("We cover these premium locations: Amsterdam, London, Dubai, and Paris.", "bot");
            }, 300);
          }
        }
      });


function sendSuggestion(text) {
  inputField.value = text;
  sendMessage();
}

// Event listeners

chatToggle.addEventListener("click", () => {
  // hide tooltip on manual click
  const tooltip = document.getElementById("chat-tooltip");
  if (tooltip) {
    tooltip.classList.remove("show");
    clearTimeout(tooltipTimer); // cancel scheduled hide if exists
  }

  chatOpened ? closeChat() : openChat();
});


chatCloseBtn.addEventListener("click", closeChat);

sendButton.addEventListener("click", sendMessage);

inputField.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

function showScheduleIntro() {
  // Remove any existing form first
  const existingForm = document.querySelector(".schedule-call-form");
  if (existingForm) {
    existingForm.parentElement.remove();
  }

  // Show the introductory message
  const container = document.createElement("div");
  container.className = "msg bot";
  container.innerHTML = `
    <p>I'll be happy to arrange a call with one of our luxury property experts.</p>
    <p>Please provide your contact information and preferred time:</p>
  `;
  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;
  
  // Show the form after a short delay
  setTimeout(showScheduleCallForm, 500);
}



document.addEventListener("click", (e) => {
  if (e.target.classList.contains("quick-btn")) {
    const text = e.target.getAttribute("data-text");
    addMessage(text, "user");
    if (text === "Browse available properties") {
      setTimeout(showPropertyForm, 300);
    } else if (text === "Schedule a call") {
      setTimeout(showScheduleIntro, 300); // Prvo poruka, pa forma
    } else if (text === "Explore neighborhoods") {
      setTimeout(() => addMessage('We serve beautiful neighborhoods across the country.', 'bot'), 300);
    }
  }
});

function showScheduleCallForm() {
  const existingForm = document.querySelector(".schedule-call-form");
  if (existingForm) {
    existingForm.parentElement.remove();
  }

  const container = document.createElement("div");
  container.className = "msg bot";

  container.innerHTML = `
    <div class="schedule-call-form" style="font-family:'Segoe UI', sans-serif; color:#1a1a2e;">
      <label for="fullName" style="font-weight:500; margin-bottom:4px; display:block;">Full Name*</label>
      <input type="text" id="fullName" placeholder="Your full name" required style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px;" />
      
      <label for="email" style="font-weight:500; margin-bottom:4px; display:block;">Email*</label>
      <input type="email" id="email" placeholder="your@email.com" required style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px;" />
      
      <label for="phone" style="font-weight:500; margin-bottom:4px; display:block;">Phone</label>
      <input type="text" id="phone" placeholder="+31 6 12345678" style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px;" />
      
      <label for="preferredDateTime" style="font-weight:500; margin-bottom:4px; display:block;">Preferred Date/Time</label>
      <input type="text" id="preferredDateTime" placeholder="e.g., May 15, 10:00 AM" style="width:100%; padding:8px; margin-bottom:12px; border:1px solid #ddd; border-radius:8px;" />
      
      <button id="submitConsultationBtn" style="background:#B38728; color:#fff; border:none; padding:10px 16px; border-radius:20px; width:100%; cursor:pointer; font-weight:600;">Request Consultation</button>
    </div>
  `;

  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;

  document.getElementById("submitConsultationBtn").onclick = submitConsultationForm;
}

async function submitConsultationForm() {
  const fullName = document.getElementById("fullName").value.trim();
  const email = document.getElementById("email").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const preferredDateTime = document.getElementById("preferredDateTime").value.trim();

  if (!fullName || !email) {
    alert("Please fill in required fields: Full Name and Email.");
    return;
  }

  const payload = {
    fullName,
    email,
    phone,
    preferredDateTime,
  };

  try {
    const res = await fetch("https://n8n-gjkiqtod.eu-central-1.clawcloudrun.com/webhook/58b4ec69-ce0b-41f5-bc87-ebf5e8c0d266", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    if (!res.ok) throw new Error("Failed to send data");

    // Ne briši formu!
    // Samo prikaz poruke zahvalnosti:
    addMessage("Thank you! Your consultation request has been sent. We will contact you soon.", "bot");
  } catch (err) {
    console.error(err);
    addMessage("Oops! Something went wrong while sending your request. Please try again later.", "bot");
  }
}


function showPropertyForm() {
   const existingForm = document.querySelector(".premium-form-title");
  if (existingForm) {
    existingForm.parentElement.remove();  // ukloni cijeli container sa formom
  }

  const container = document.createElement("div");
  container.className = "msg bot";
  container.innerHTML = `
    <div class="premium-form-title">Premium Property Search</div>
    <label>Location</label>
    <select id="location">
      <option>Amsterdam</option>
      <option>London</option>
      <option>Dubai</option>
    </select>
    <label>Price Range</label>
    <select id="price">
      <option>Any Price</option>
      <option>€50k - €100k</option>
      <option>€100k - €200k</option>
      <option>€200k - €300k</option>
    </select>
    <label>Property Type</label>
    <select id="type">
      <option>Any Type</option>
      <option>Apartment</option>
      <option>House</option>
      <option>Villa</option>
    </select>
    <button id="submitSearchBtn">Find Exclusive Properties</button>
  `;
  messages.appendChild(container);
  messages.scrollTop = messages.scrollHeight;

  document.getElementById("submitSearchBtn").onclick = submitSearch;
}

function submitSearch() {
  const location = document.getElementById("location").value;
  const price = document.getElementById("price").value;
  const type = document.getElementById("type").value;
  const finalType = type === 'Any Type' ? 'House, Apartment' : type;
  const query = `Search for ${finalType} in ${location} ${price !== 'Any Price' ? 'priced ' + price : ''}`;

  inputField.value = query.trim();
  sendMessage();
}


    })();
  </script>
</body>
</html>
